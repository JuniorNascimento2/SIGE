{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ gestor.pk|yesno:"Editar,Cadastrar" }} Gestor{% endblock %}
{% block header_title %}{{ gestor.pk|yesno:"Editar,Cadastrar" }} Gestor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/cadastro_gestor.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container">
    <main>
        <div class="topo-formulario">
            <h1>{{ gestor.pk|yesno:"Editar,Cadastrar" }} Gestor</h1>
        </div>

        <div class="conteudo-principal-rolavel">
            <div class="passos-indicadores">
                <span class="passo ativo" id="passo-1">1. Dados Pessoais</span>
                <span class="passo inativo" id="passo-2">2. Endereço</span>
                <span class="passo inativo" id="passo-3">3. Cargo</span>
            </div>

            <form method="POST" class="formulario" enctype="multipart/form-data" id="form-gestor">
                {% csrf_token %}

                <!-- ETAPA 1 -->
                <div class="etapa ativa" id="etapa-1">
                    <div class="caixa-texto">
                        <label class="required">Nome completo</label>
                        {{ form.nome_completo }}
                        {% if form.nome_completo.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.nome_completo.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">CPF</label>
                        {{ form.cpf }}
                        {% if form.cpf.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.cpf.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">Data de nascimento</label>
                        {% if gestor.pk and gestor.data_nascimento %}
                            <input type="date" name="data_nascimento" value="{{ gestor.data_nascimento|date:'Y-m-d' }}" required id="id_data_nascimento">
                        {% else %}
                            {{ form.data_nascimento }}
                        {% endif %}
                        {% if form.data_nascimento.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.data_nascimento.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">Telefone</label>
                        {{ form.telefone }}
                        {% if form.telefone.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.telefone.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">E-mail</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.email.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="botoes">
                        <button type="button" class="btn" onclick="validarEtapa(1)">Próximo</button>
                    </div>
                </div>

                <!-- ETAPA 2 -->
                <div class="etapa" id="etapa-2">
                    <div class="caixa-texto">
                        <label class="required">CEP</label>
                        {{ form.cep }}
                        {% if form.cep.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.cep.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">UF</label>
                        {{ form.uf }}
                        {% if form.uf.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.uf.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">Cidade</label>
                        {{ form.cidade }}
                        {% if form.cidade.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.cidade.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label class="required">Endereço</label>
                        {{ form.endereco }}
                        {% if form.endereco.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.endereco.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="botoes">
                        <button type="button" class="btn-voltar-tab" onclick="voltarEtapa(2)">Anterior</button>
                        <button type="button" class="btn" onclick="validarEtapa(2)">Próximo</button>
                    </div>
                </div>

                <!-- ETAPA 3 -->
                <div class="etapa" id="etapa-3">
                    <div class="caixa-texto">
                        <label class="required">Cargo</label>
                        {{ form.cargo }}
                        {% if form.cargo.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.cargo.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="caixa-texto">
                        <label {% if not gestor.pk %}class="required"{% endif %}>
                            Senha
                            {% if gestor.pk %}
                                <small style="color: #666; font-weight: normal;"> (deixe em branco para manter a senha atual)</small>
                            {% endif %}
                        </label>
                        {{ form.senha }}
                        {% if form.senha.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.senha.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="requisitos-senha" id="requisitos-senha-container" {% if gestor.pk %}style="display:none;"{% endif %}>
                        <div class="requisito" id="req-maiuscula"><i class="fa-solid fa-xmark"></i> Pelo menos 1 letra maiúscula</div>
                        <div class="requisito" id="req-minuscula"><i class="fa-solid fa-xmark"></i> Pelo menos 1 letra minúscula</div>
                        <div class="requisito" id="req-numero"><i class="fa-solid fa-xmark"></i> Pelo menos 1 número</div>
                        <div class="requisito" id="req-caractere"><i class="fa-solid fa-xmark"></i> Pelo menos 6 caracteres</div>
                    </div>

                    <div class="caixa-texto" id="confirmar-senha-container" {% if gestor.pk %}style="display:none;"{% endif %}>
                        <label {% if not gestor.pk %}class="required"{% endif %}>Confirmar senha</label>
                        {{ form.senha_confirmacao }}
                        {% if form.senha_confirmacao.errors %}
                            <small class="erro-inline" style="display:block;">{{ form.senha_confirmacao.errors.0 }}</small>
                        {% else %}
                            <small class="erro-inline"></small>
                        {% endif %}
                    </div>

                    <div class="confirmacao-senha" id="senha-match-msg" style="display:none;">As senhas não coincidem</div>

                    <div class="caixa-texto upload-foto">
                        <label>Foto de Perfil</label>
                        <div class="upload-container">
                            <label class="botao-upload">
                                <i class="fa-solid fa-camera"></i>
                                <span>Selecionar Imagem</span>
                                {{ form.foto }}
                            </label>
                            <div class="preview-foto">
                                {% if gestor.pk and gestor.foto %}
                                    <img id="preview-imagem" src="{{ gestor.foto.url }}" alt="Foto atual" style="display:block;">
                                {% else %}
                                    <img id="preview-imagem" src="" alt="Pré-visualização">
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Exibir erros não-field (do clean() do form) -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors.0 }}
                        </div>
                    {% endif %}

                    <div class="botoes">
                        <button type="button" class="btn-voltar-tab" onclick="voltarEtapa(3)">Anterior</button>
                        <button type="submit" class="btn">{{ gestor.pk|yesno:"Atualizar,Salvar" }} Cadastro</button>
                    </div>
                </div>

            </form>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
const isEdicao = {{ gestor.pk|yesno:"true,false" }};

// Detecta qual etapa tem erro e abre ela
document.addEventListener('DOMContentLoaded', function() {
    const etapas = document.querySelectorAll('.etapa');
    let etapaComErro = null;

    etapas.forEach((etapa, index) => {
        if (etapa.querySelector('.erro-inline[style*="display:block"]') || 
            etapa.querySelector('.alert-danger')) {
            etapaComErro = index + 1;
        }
    });

    if (etapaComErro) {
        etapas.forEach(e => e.classList.remove('ativa'));
        document.getElementById(`etapa-${etapaComErro}`).classList.add('ativa');
        atualizarIndicadores(etapaComErro);
    }
});

// Adiciona IDs e atributos nos campos do form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-gestor');
    
    const cpfInput = form.querySelector('[name="cpf"]');
    if (cpfInput) {
        cpfInput.id = 'cpf';
        cpfInput.maxLength = 14;
    }
    
    const telefoneInput = form.querySelector('[name="telefone"]');
    if (telefoneInput) {
        telefoneInput.id = 'telefone';
        telefoneInput.maxLength = 15;
    }
    
    const cepInput = form.querySelector('[name="cep"]');
    if (cepInput) {
        cepInput.id = 'cep';
        cepInput.maxLength = 9;
    }
    
    const ufSelect = form.querySelector('[name="uf"]');
    if (ufSelect) ufSelect.id = 'uf';
    
    const cidadeInput = form.querySelector('[name="cidade"]');
    if (cidadeInput) {
        cidadeInput.id = 'cidade';
        cidadeInput.placeholder = 'Digite a cidade se não encontrar pelo CEP';
    }
    
    const senhaInput = form.querySelector('[name="senha"]');
    if (senhaInput) {
        senhaInput.id = 'senha';
        senhaInput.minLength = 6;
    }
    
    const senhaConfirmInput = form.querySelector('[name="senha_confirmacao"]');
    if (senhaConfirmInput) senhaConfirmInput.id = 'senha_confirmacao';
    
    const fotoInput = form.querySelector('[name="foto"]');
    if (fotoInput) {
        fotoInput.accept = 'image/*';
        fotoInput.addEventListener('change', function() {
            previewFoto(this);
        });
    }
});

// --- LÓGICA DE SENHA NA EDIÇÃO ---
document.addEventListener('DOMContentLoaded', function() {
    if (!isEdicao) return; // só executa na edição

    const senhaInput = document.getElementById('senha');
    const requisitosContainer = document.getElementById('requisitos-senha-container');
    const confirmarContainer = document.getElementById('confirmar-senha-container');

    if (senhaInput) {
        senhaInput.addEventListener('input', function() {
            // Se digitar algo na senha, mostra confirmação e requisitos
            if (this.value.length > 0) {
                requisitosContainer.style.display = 'block';
                confirmarContainer.style.display = 'flex';
            } else {
                requisitosContainer.style.display = 'none';
                confirmarContainer.style.display = 'none';
            }
        });
    }
});

// --- Multi-step e validação ---
function atualizarIndicadores(etapaAtiva) {
    for (let i = 1; i <= 3; i++) {
        const indicador = document.getElementById(`passo-${i}`);
        indicador.classList.remove("ativo", "completo");
        if (i < etapaAtiva) indicador.classList.add("completo");
        else if (i === etapaAtiva) indicador.classList.add("ativo");
    }
}

function validarEtapa(n) {
    const etapa = document.getElementById(`etapa-${n}`);
    const campos = etapa.querySelectorAll("input[required], select[required]");
    let valido = true;
    
    campos.forEach(campo => {
        const erro = campo.nextElementSibling;
        
        // Na edição, senha não é obrigatória
        if (isEdicao && (campo.name === 'senha' || campo.name === 'senha_confirmacao')) {
            return; // pula validação
        }
        
        if (!campo.value.trim()) {
            campo.classList.add("campo-erro");
            if (erro && erro.classList.contains('erro-inline')) {
                erro.innerText = "Campo obrigatório";
                erro.style.display = "block";
            }
            valido = false;
        } else {
            campo.classList.remove("campo-erro");
            if (erro && erro.classList.contains('erro-inline')) {
                erro.style.display = "none";
            }
        }
    });
    
    if (valido) proximaEtapa(n);
}

function proximaEtapa(n) {
    document.getElementById(`etapa-${n}`).classList.remove("ativa");
    document.getElementById(`etapa-${n+1}`).classList.add("ativa");
    atualizarIndicadores(n+1);
}

function voltarEtapa(n) {
    document.getElementById(`etapa-${n}`).classList.remove("ativa");
    document.getElementById(`etapa-${n-1}`).classList.add("ativa");
    atualizarIndicadores(n-1);
}

// --- Máscaras de CPF, telefone e CEP ---
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g,'').slice(0,11);
            v = v.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');
            e.target.value = v;
        });
    }

    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g,'').slice(0,11);
            v = v.length > 10 ? v.replace(/(\d{2})(\d{5})(\d{4})/,'($1) $2-$3')
                              : v.replace(/(\d{2})(\d{4})(\d{4})/,'($1) $2-$3');
            e.target.value = v;
        });
    }

    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g,'').slice(0,8);
            e.target.value = v.replace(/(\d{5})(\d)/,'$1-$2');
        });

        cepInput.addEventListener('blur', function() {
            let cep = this.value.replace(/\D/g,'');
            if(cep.length !== 8) return;

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    const ufSelect = document.getElementById('uf');
                    const cidadeInput = document.getElementById('cidade');
                    if(data.erro) {
                        ufSelect.value = '';
                        cidadeInput.value = '';
                    } else {
                        ufSelect.value = data.uf;
                        cidadeInput.value = data.localidade;
                    }
                })
                .catch(err => console.error("Erro ao consultar CEP:", err));
        });
    }
});

// --- Preview de foto ---
function previewFoto(input) {
    const img = document.getElementById('preview-imagem');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            img.src = e.target.result;
            img.style.display = "block";
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// --- Validação de senha ---
document.addEventListener('DOMContentLoaded', function() {
    const senha = document.getElementById('senha');
    const senhaConfirm = document.getElementById('senha_confirmacao');
    const senhaMatchMsg = document.getElementById('senha-match-msg');

    if (senha) {
        senha.addEventListener('input', () => {
            const val = senha.value;
            const regras = [
                { id: 'req-maiuscula', regex: /[A-Z]/ },
                { id: 'req-minuscula', regex: /[a-z]/ },
                { id: 'req-numero', regex: /\d/ },
                { id: 'req-caractere', regex: /.{6,}/ }
            ];
            regras.forEach(r => {
                const el = document.getElementById(r.id);
                if(el && r.regex.test(val)) {
                    el.classList.add('valid');
                    el.querySelector('i').className = 'fa-solid fa-check';
                } else if(el) {
                    el.classList.remove('valid');
                    el.querySelector('i').className = 'fa-solid fa-xmark';
                }
            });
            verificarSenhaConfirm();
        });
    }

    if (senhaConfirm) senhaConfirm.addEventListener('input', verificarSenhaConfirm);

    function verificarSenhaConfirm() {
        if(!senhaConfirm || senhaConfirm.value === "") { 
            if(senhaMatchMsg) senhaMatchMsg.style.display = "none"; 
            return; 
        }
        if(senha.value === senhaConfirm.value) {
            senhaMatchMsg.innerText = "Senhas coincidem";
            senhaMatchMsg.style.display = "block";
            senhaMatchMsg.classList.add('valid');
        } else {
            senhaMatchMsg.innerText = "As senhas não coincidem";
            senhaMatchMsg.style.display = "block";
            senhaMatchMsg.classList.remove('valid');
        }
    }
});
</script>
{% endblock %}