{% extends 'core/base.html' %}
{% load static %}
{% load l10n %}

{% block title %}Meu Painel{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/painel_aluno.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}

<div class="container-centralizado">
    <main class="conteudo-principal">

        <!-- HEADER -->
        <div class="header-painel">
            <div class="saudacao">
                <h1>Ol√°, {{ aluno.nome_completo|truncatewords:2 }}! üëã</h1>
                <p>{{ aluno.turma.nome }} ‚Ä¢ {{ aluno.turma.get_turno_display }}</p>
            </div>
            
            <button onclick="imprimirBoletim()" class="btn-imprimir">
                <i class="fa-solid fa-print"></i> Imprimir Boletim
            </button>
        </div>

        <!-- CARDS DE RESUMO -->
        <section class="cards-resumo">
            <div class="card-info">
                <div class="card-icon">üìö</div>
                <div class="card-dados">
                    <p>Disciplinas</p>
                    <h3>{{ disciplinas_com_notas|length }}</h3>
                </div>
            </div>

            <div class="card-info">
                <div class="card-icon">üìä</div>
                <div class="card-dados">
                    <p>M√©dia Geral</p>
                    <h3>{{ media_geral|floatformat:1|default:"--" }}</h3>
                </div>
            </div>

            <div class="card-info">
                <div class="card-icon">üéØ</div>
                <div class="card-dados">
                    {% if total_notas_possiveis > 0 and total_notas_lancadas == total_notas_possiveis %}

                        {# ==========================
                           SITUA√á√ÉO GERAL (CORRETA)
                           Reprovado: existe alguma disciplina com media <= 4
                           Recupera√ß√£o: n√£o tem <=4, mas existe alguma com media < 6
                           Aprovado: todas com media >= 6
                           ========================== #}

                        {# flags #}
                        {% with tem_reprovacao=False tem_recuperacao=False %}

                            {# 1) verifica se tem reprovado em alguma disciplina (<=4) #}
                            {% for item in disciplinas_com_notas %}
                                {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                                    {% if item.nota.media <= 4 %}
                                        {% with tem_reprovacao=True %}{% endwith %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {# 2) se n√£o reprovou, verifica recupera√ß√£o (media < 6) #}
                            {% if not tem_reprovacao %}
                                {% for item in disciplinas_com_notas %}
                                    {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                                        {% if item.nota.media < 6 %}
                                            {% with tem_recuperacao=True %}{% endwith %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}

                            <p>Situa√ß√£o</p>
                            <h3>
                                {% if tem_reprovacao %}
                                    Reprovado
                                {% elif tem_recuperacao %}
                                    Recupera√ß√£o
                                {% else %}
                                    Aprovado
                                {% endif %}
                            </h3>

                        {% endwith %}

                    {% else %}
                        <p>Notas Lan√ßadas</p>
                        <h3>{{ total_notas_lancadas }}/{{ total_notas_possiveis }}</h3>
                    {% endif %}
                </div>
            </div>
        </section>

        <div class="conteudo-geral">

            <!-- DISCIPLINAS E NOTAS -->
            <div class="secao-disciplinas">
                <h2>üìñ Minhas Disciplinas e Notas</h2>
                
                <div class="lista-disciplinas">
                    {% for item in disciplinas_com_notas %}
                    <div class="disciplina-card">
                        <div class="disciplina-header" onclick="toggleNotas(this)">
                            <div class="disciplina-info">
                                <h3>{{ item.disciplina.nome }}</h3>
                                <p>Prof. {{ item.disciplina.professor.nome_completo }}</p>

                                {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                                    <p style="margin-top:6px;">
                                        <strong>Situa√ß√£o:</strong>
                                        {% if item.nota.media >= 6 %}
                                            <span>Aprovado</span>
                                        {% elif item.nota.media > 4 %}
                                            <span>Recupera√ß√£o</span>
                                        {% else %}
                                            <span>Reprovado</span>
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>

                            <div class="disciplina-media">
                                <span class="label">M√©dia</span>
                                <span class="valor-media">
                                    {{ item.nota.media|floatformat:1|default:"--" }}
                                </span>
                            </div>

                            <i class="fa-solid fa-chevron-down seta"></i>
                        </div>
                        
                        <div class="disciplina-notas">
                            <div class="nota-item">
                                <span class="nota-label">1¬∫ Bimestre</span>
                                <span class="nota-valor">{{ item.nota.nota1|default:"--" }}</span>
                            </div>
                            <div class="nota-item">
                                <span class="nota-label">2¬∫ Bimestre</span>
                                <span class="nota-valor">{{ item.nota.nota2|default:"--" }}</span>
                            </div>
                            <div class="nota-item">
                                <span class="nota-label">3¬∫ Bimestre</span>
                                <span class="nota-valor">{{ item.nota.nota3|default:"--" }}</span>
                            </div>
                            <div class="nota-item">
                                <span class="nota-label">4¬∫ Bimestre</span>
                                <span class="nota-valor">{{ item.nota.nota4|default:"--" }}</span>
                            </div>

                            {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                            <div class="nota-item">
                                <span class="nota-label"><strong>Situa√ß√£o</strong></span>
                                <span class="nota-valor">
                                    {% if item.nota.media >= 6 %}
                                        <strong>Aprovado</strong>
                                    {% elif item.nota.media > 4 %}
                                        <strong>Recupera√ß√£o</strong>
                                    {% else %}
                                        <strong>Reprovado</strong>
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- COLUNA DIREITA -->
            <div class="coluna-direita">
                
                <!-- GR√ÅFICO DE DESEMPENHO -->
                <div class="card-grafico">
                    <h3>üìà Meu Desempenho</h3>
                    <canvas id="graficoDesempenho"></canvas>
                </div>

                <!-- CALEND√ÅRIO -->
                <div class="calendario">
                    <div class="calendario-cabecalho">
                        <h2>{{ agora|date:"F"|upper }}</h2>
                        <span class="calendario-ano">{{ agora|date:"Y" }}</span>
                    </div>

                    <div class="calendario-grade">
                        <div class="nome-dia">D</div>
                        <div class="nome-dia">S</div>
                        <div class="nome-dia">T</div>
                        <div class="nome-dia">Q</div>
                        <div class="nome-dia">Q</div>
                        <div class="nome-dia">S</div>
                        <div class="nome-dia">S</div>

                        {% for celula in calendario %}
                            <div class="dia {% if celula.hoje %}atual{% endif %} {% if celula.vazio %}vazio{% endif %}">
                                {% if not celula.vazio %}{{ celula.numero }}{% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>

            </div>

        </div>

        <!-- GRADE HOR√ÅRIA -->
        <div class="secao-grade">
            <h2>üïê Grade Hor√°ria - {{ aluno.turma.nome }}</h2>
            
            {% if grade_horario %}
            <div class="grade-wrapper">
                <table class="grade-table">
                    <thead>
                        <tr>
                            <th>Hor√°rio</th>
                            <th>Segunda</th>
                            <th>Ter√ßa</th>
                            <th>Quarta</th>
                            <th>Quinta</th>
                            <th>Sexta</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for horario, aulas in grade_horario.items %}
                        <tr>
                            <td class="horario-col">{{ horario }}</td>
                            <td>{{ aulas.segunda|default:"--" }}</td>
                            <td>{{ aulas.terca|default:"--" }}</td>
                            <td>{{ aulas.quarta|default:"--" }}</td>
                            <td>{{ aulas.quinta|default:"--" }}</td>
                            <td>{{ aulas.sexta|default:"--" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="aviso-grade">Grade hor√°ria ainda n√£o definida para sua turma.</p>
            {% endif %}
        </div>

    </main>
</div>

<!-- MODAL DE IMPRESS√ÉO -->
<div id="modal-impressao" class="modal-impressao">
    <div class="modal-conteudo">
        <span class="fechar-modal" onclick="fecharModal()">&times;</span>
        
        <div id="boletim-imprimir" class="boletim-imprimir">
            <div class="boletim-header">
                <h1>BOLETIM ESCOLAR</h1>
                <p class="sistema">Documento gerado pelo SIGE</p>
            </div>

            <div class="boletim-info-aluno">
                <div class="info-linha">
                    <span class="label">Nome:</span>
                    <span class="valor">{{ aluno.nome_completo }}</span>
                </div>
                <div class="info-linha">
                    <span class="label">CPF:</span>
                    <span class="valor">{{ aluno.cpf }}</span>
                </div>
                <div class="info-linha">
                    <span class="label">Data de Nascimento:</span>
                    <span class="valor">{{ aluno.data_nascimento|date:"d/m/Y" }}</span>
                </div>
                <div class="info-linha">
                    <span class="label">Turma:</span>
                    <span class="valor">{{ aluno.turma.nome }}</span>
                </div>
                <div class="info-linha">
                    <span class="label">Turno:</span>
                    <span class="valor">{{ aluno.turma.get_turno_display }}</span>
                </div>
                <div class="info-linha">
                    <span class="label">Ano Letivo:</span>
                    <span class="valor">{{ aluno.turma.ano }}</span>
                </div>
            </div>

            <table class="boletim-tabela">
                <thead>
                    <tr>
                        <th>Disciplina</th>
                        <th>1¬∫ Bim</th>
                        <th>2¬∫ Bim</th>
                        <th>3¬∫ Bim</th>
                        <th>4¬∫ Bim</th>
                        <th>M√©dia</th>
                        <th>Situa√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in disciplinas_com_notas %}
                    <tr>
                        <td>{{ item.disciplina.nome }}</td>
                        <td>{{ item.nota.nota1|default:"--" }}</td>
                        <td>{{ item.nota.nota2|default:"--" }}</td>
                        <td>{{ item.nota.nota3|default:"--" }}</td>
                        <td>{{ item.nota.nota4|default:"--" }}</td>
                        <td><strong>{{ item.nota.media|floatformat:1|default:"--" }}</strong></td>
                        <td>
                            {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                                {% if item.nota.media >= 6 %}
                                    <strong>Aprovado</strong>
                                {% elif item.nota.media > 4 %}
                                    <strong>Recupera√ß√£o</strong>
                                {% else %}
                                    <strong>Reprovado</strong>
                                {% endif %}
                            {% else %}
                                --
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5"><strong>M√©dia Geral</strong></td>
                        <td><strong>{{ media_geral|floatformat:1|default:"--" }}</strong></td>
                        <td>
                            {% if total_notas_possiveis > 0 and total_notas_lancadas == total_notas_possiveis %}

                                {% with tem_reprovacao=False tem_recuperacao=False %}

                                    {% for item in disciplinas_com_notas %}
                                        {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                                            {% if item.nota.media <= 4 %}
                                                {% with tem_reprovacao=True %}{% endwith %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if not tem_reprovacao %}
                                        {% for item in disciplinas_com_notas %}
                                            {% if item.nota and item.nota.nota1 != None and item.nota.nota2 != None and item.nota.nota3 != None and item.nota.nota4 != None %}
                                                {% if item.nota.media < 6 %}
                                                    {% with tem_recuperacao=True %}{% endwith %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    {% if tem_reprovacao %}
                                        <strong>Reprovado</strong>
                                    {% elif tem_recuperacao %}
                                        <strong>Recupera√ß√£o</strong>
                                    {% else %}
                                        <strong>Aprovado</strong>
                                    {% endif %}

                                {% endwith %}

                            {% else %}
                                --
                            {% endif %}
                        </td>
                    </tr>
                </tfoot>
            </table>

            <div class="boletim-footer">
                <p><strong>Data de emiss√£o:</strong> {{ agora|date:"d/m/Y √†s H:i" }}</p>
                <p class="assinatura">_______________________________</p>
                <p class="assinatura-texto">Assinatura do Respons√°vel</p>
            </div>
        </div>

        <button onclick="window.print()" class="btn-imprimir-modal">
            <i class="fa-solid fa-print"></i> Imprimir
        </button>
    </div>
</div>

<script>
// Toggle disciplinas
function toggleNotas(element) {
    const card = element.parentElement;
    const seta = element.querySelector('.seta');
    
    card.classList.toggle('aberto');
    
    if (card.classList.contains('aberto')) {
        seta.style.transform = 'rotate(180deg)';
    } else {
        seta.style.transform = 'rotate(0deg)';
    }
}

// Modal de impress√£o
function imprimirBoletim() {
    document.getElementById('modal-impressao').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modal-impressao').style.display = 'none';
}

// Fechar modal clicando fora
window.onclick = function(event) {
    const modal = document.getElementById('modal-impressao');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// GR√ÅFICO DE DESEMPENHO
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('graficoDesempenho');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [
                    {% for item in disciplinas_com_notas %}
                        '{{ item.disciplina.nome|truncatechars:15 }}'{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'M√©dia',
                    data: [
                        {% for item in disciplinas_com_notas %}
                            {{ item.nota.media|default_if_none:0|unlocalize }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(66, 133, 244, 0.7)',
                    borderColor: 'rgba(66, 133, 244, 1)',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 2
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}
